<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ecos de Aetherion - O Despertar</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            overflow: hidden;
            background: #000;
            font-family: 'Lora', serif;
            color: #e0d5b5;
        }

        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            image-rendering: pixelated;
        }

        .ui-layer {
            position: fixed;
            z-index: 10;
            pointer-events: none;
            width: 100%;
            height: 100%;
        }

        .interactive {
            pointer-events: auto;
        }

        /* Menu Principal */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0f0f1e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 1s ease;
        }

        .title-container {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            animation: titleFloat 6s ease-in-out infinite;
        }

        @keyframes titleFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .game-title {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.8rem, 7vw, 3.5rem);
            color: #e0d5b5;
            text-shadow: 
                0 0 20px rgba(224, 213, 181, 0.5),
                0 0 40px rgba(224, 213, 181, 0.3),
                0 0 60px rgba(180, 160, 120, 0.2),
                0 0 80px rgba(255, 215, 0, 0.1);
            letter-spacing: 0.15em;
            animation: titlePulse 4s ease-in-out infinite;
        }

        .subtitle {
            font-size: clamp(0.7rem, 2.5vw, 1rem);
            color: #8b9dc3;
            margin-top: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.4em;
            animation: subtitleGlow 3s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 20px rgba(255,215,0,0.2)); }
            50% { filter: brightness(1.3) drop-shadow(0 0 40px rgba(255,215,0,0.5)); }
        }

        @keyframes subtitleGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; text-shadow: 0 0 10px rgba(139, 157, 195, 0.5); }
        }

        .menu-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 85%;
            max-width: 350px;
            margin-top: 20px;
        }

        .menu-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(224, 213, 181, 0.3);
            color: #e0d5b5;
            padding: 18px;
            font-size: 1rem;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            backdrop-filter: blur(10px);
            border-radius: 8px;
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(224, 213, 181, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .menu-btn:hover::before, .menu-btn:active::before {
            left: 100%;
        }

        .menu-btn:hover, .menu-btn:active {
            background: rgba(224, 213, 181, 0.15);
            border-color: rgba(224, 213, 181, 0.8);
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(224, 213, 181, 0.3), inset 0 0 20px rgba(224, 213, 181, 0.1);
        }

        .save-info {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            font-family: 'Lora', serif;
            font-style: italic;
        }

        /* HUD */
        #gameHUD {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud-top {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .bar-container {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #5c4033;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .health-bar {
            width: 180px;
            height: 22px;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a0000, #8b0000, #ff4444, #ff6666);
            width: 100%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 0 10px rgba(255,0,0,0.3);
            position: relative;
        }

        .health-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.3), transparent);
        }

        .mana-bar {
            width: 140px;
            height: 16px;
        }

        .mana-fill {
            height: 100%;
            background: linear-gradient(90deg, #0a1628, #1e3a5f, #4a90e2, #87ceeb);
            width: 100%;
            transition: width 0.4s ease;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.4);
        }

        .exp-bar {
            width: 180px;
            height: 8px;
            margin-top: 5px;
            border-radius: 4px;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a3f00, #ffd700, #ffed4e);
            width: 0%;
            transition: width 0.5s ease;
        }

        .level-badge {
            position: absolute;
            left: 195px;
            top: 0;
            background: linear-gradient(135deg, #4a3f00, #ffd700);
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .resources {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .resource-item {
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(224, 213, 181, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        .minimap {
            width: 110px;
            height: 110px;
            background: radial-gradient(circle, rgba(20, 30, 48, 0.95), rgba(0, 0, 0, 0.98));
            border: 2px solid #5c4033;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 30px rgba(0,0,0,0.5);
        }

        .minimap-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200%;
            height: 200%;
        }

        .minimap-player {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #ffd700;
            z-index: 10;
        }

        /* Controles Mobile */
        .controls-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
        }

        .joystick-area {
            pointer-events: auto;
            width: 140px;
            height: 140px;
            position: relative;
        }

        .joystick {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(224, 213, 181, 0.25);
            border-radius: 50%;
            position: relative;
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .joystick-knob {
            width: 45px;
            height: 45px;
            background: radial-gradient(circle at 30% 30%, rgba(224, 213, 181, 0.9), rgba(180, 160, 120, 0.6));
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4), 0 0 15px rgba(224, 213, 181, 0.3);
            transition: transform 0.05s ease;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }

        .action-row {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .action-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: rgba(139, 69, 19, 0.25);
            border: 2px solid rgba(224, 213, 181, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: #e0d5b5;
            backdrop-filter: blur(8px);
            transition: all 0.15s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .action-btn:active::before {
            width: 100%;
            height: 100%;
        }

        .action-btn:active {
            transform: scale(0.92);
            background: rgba(224, 213, 181, 0.2);
            box-shadow: 0 0 30px rgba(224, 213, 181, 0.4);
        }

        .action-btn.attack {
            background: rgba(139, 0, 0, 0.35);
            border-color: rgba(255, 68, 68, 0.5);
            width: 75px;
            height: 75px;
        }

        .action-btn.echo {
            background: rgba(0, 100, 200, 0.3);
            border-color: rgba(100, 200, 255, 0.5);
        }

        .action-btn.interact {
            background: rgba(255, 215, 0, 0.25);
            border-color: rgba(255, 215, 0, 0.5);
        }

        /* Sistema de Di√°logo */
        #dialogueSystem {
            position: absolute;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 650px;
            display: none;
            pointer-events: auto;
        }

        .dialogue-box {
            background: linear-gradient(180deg, rgba(10, 10, 20, 0.95), rgba(5, 5, 15, 0.98));
            border: 2px solid rgba(224, 213, 181, 0.4);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.8), 0 0 40px rgba(224, 213, 181, 0.1);
            position: relative;
            overflow: hidden;
        }

        .dialogue-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(224, 213, 181, 0.6), transparent);
        }

        .dialogue-speaker {
            color: #ffd700;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speaker-portrait {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(224, 213, 181, 0.5);
            background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
        }

        .dialogue-text {
            color: #e0d5b5;
            font-size: 1rem;
            line-height: 1.7;
            min-height: 60px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .dialogue-choices {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-btn {
            background: rgba(224, 213, 181, 0.1);
            border: 1px solid rgba(224, 213, 181, 0.3);
            color: #e0d5b5;
            padding: 12px 20px;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-family: 'Lora', serif;
            position: relative;
            padding-left: 40px;
        }

        .choice-btn::before {
            content: '‚ñ∏';
            position: absolute;
            left: 15px;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .choice-btn:hover, .choice-btn:active {
            background: rgba(224, 213, 181, 0.2);
            border-color: rgba(224, 213, 181, 0.6);
            padding-left: 45px;
        }

        .choice-btn:hover::before, .choice-btn:active::before {
            opacity: 1;
            left: 20px;
        }

        .dialogue-indicator {
            position: absolute;
            bottom: 15px;
            right: 25px;
            width: 30px;
            height: 30px;
            border: 2px solid rgba(224, 213, 181, 0.5);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Invent√°rio */
        #inventoryPanel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            z-index: 50;
            padding: 20px;
            overflow-y: auto;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(224, 213, 181, 0.1);
            border: 2px solid rgba(224, 213, 181, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .inventory-slot:hover {
            background: rgba(224, 213, 181, 0.2);
            transform: scale(1.05);
        }

        /* Notifica√ß√µes */
        #notificationArea {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 40;
            pointer-events: none;
        }

        .notification {
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(224, 213, 181, 0.4);
            padding: 15px 25px;
            border-radius: 10px;
            color: #e0d5b5;
            font-size: 0.95rem;
            animation: slideDown 0.4s ease, fadeOut 0.4s ease 4s forwards;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 300px;
            text-align: center;
        }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* Tela de Carregamento Corrigida */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #loadingScreen.active {
            display: flex;
            opacity: 1;
        }

        .loading-content {
            text-align: center;
        }

        .rune-circle {
            width: 100px;
            height: 100px;
            border: 3px solid transparent;
            border-top-color: #e0d5b5;
            border-right-color: rgba(224, 213, 181, 0.5);
            border-radius: 50%;
            animation: spin 2s linear infinite;
            margin: 0 auto 30px;
            position: relative;
            box-shadow: 0 0 30px rgba(224, 213, 181, 0.2);
        }

        .rune-circle::before {
            content: '';
            position: absolute;
            inset: 10px;
            border: 2px solid transparent;
            border-bottom-color: #ffd700;
            border-left-color: rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            animation: spinReverse 3s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes spinReverse { to { transform: rotate(-360deg); } }

        .loading-text {
            color: #e0d5b5;
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            letter-spacing: 0.3em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(224, 213, 181, 0.5);
        }

        .loading-tip {
            color: #8b9dc3;
            font-size: 0.9rem;
            font-style: italic;
            max-width: 300px;
            line-height: 1.5;
            opacity: 0.8;
        }

        .progress-bar {
            width: 250px;
            height: 4px;
            background: rgba(224, 213, 181, 0.2);
            border-radius: 2px;
            margin-top: 30px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e0d5b5, #ffd700);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(224, 213, 181, 0.5);
        }

        /* Indicador de Regi√£o */
        .region-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0;
            transition: opacity 2s ease;
            pointer-events: none;
        }

        .region-indicator.show {
            opacity: 1;
        }

        .region-name {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: #e0d5b5;
            text-shadow: 0 0 40px rgba(0,0,0,0.9), 0 0 80px rgba(224, 213, 181, 0.3);
            margin-bottom: 10px;
            letter-spacing: 0.2em;
        }

        .region-subtitle {
            font-size: 1rem;
            color: #8b9dc3;
            letter-spacing: 0.3em;
            text-transform: uppercase;
        }

        /* Efeito de dano */
        .damage-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(139, 0, 0, 0.4) 100%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 45;
        }

        .damage-overlay.active {
            opacity: 1;
        }

        /* Quest Log */
        #questLog {
            position: absolute;
            top: 80px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(224, 213, 181, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-width: 250px;
            display: none;
            backdrop-filter: blur(5px);
        }

        .quest-title {
            color: #ffd700;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .quest-description {
            font-size: 0.8rem;
            color: #aaa;
            line-height: 1.4;
        }

        /* Menu de Pausa */
        #pauseMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            z-index: 60;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .pause-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #e0d5b5;
            margin-bottom: 40px;
        }

        /* Anima√ß√µes de Ambiente */
        @keyframes leafSway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
    </style>
</head>
<body>

    <!-- Tela de Carregamento -->
    <div id="loadingScreen">
        <div class="loading-content">
            <div class="rune-circle"></div>
            <div class="loading-text">CARREGANDO AETHERION</div>
            <div class="loading-tip" id="loadingTip">Os cristais antigos sussurram segredos do passado...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- Menu Principal -->
    <div id="mainMenu" class="interactive">
        <div class="title-container">
            <h1 class="game-title">ECOS DE AETHERION</h1>
            <div class="subtitle">O Despertar do Eco</div>
        </div>
        <div class="menu-options">
            <button class="menu-btn" onclick="startNewGame()">
                Nova Jornada
                <div class="save-info">Inicie uma nova aventura √©pica</div>
            </button>
            <button class="menu-btn" onclick="loadGame()">
                Continuar Jornada
                <div class="save-info" id="saveInfo">Nenhum save encontrado</div>
            </button>
            <button class="menu-btn" onclick="showSettings()">
                Configura√ß√µes
            </button>
        </div>
    </div>

    <!-- Canvas do Jogo -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD do Jogo -->
    <div id="gameHUD" class="ui-layer">
        <div class="hud-top">
            <div class="stats-container">
                <div style="position: relative;">
                    <div class="bar-container health-bar">
                        <div class="health-fill" id="healthFill"></div>
                    </div>
                    <div class="level-badge" id="levelBadge">1</div>
                </div>
                <div class="bar-container mana-bar">
                    <div class="mana-fill" id="manaFill"></div>
                </div>
                <div class="bar-container exp-bar">
                    <div class="exp-fill" id="expFill"></div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <div class="resources">
                    <div class="resource-item">
                        <span>üíé</span>
                        <span id="crystalCount">0/4</span>
                    </div>
                    <div class="resource-item">
                        <span>ü™ô</span>
                        <span id="goldCount">0</span>
                    </div>
                </div>
                <div class="minimap" id="minimap">
                    <div class="minimap-content" id="minimapContent"></div>
                    <div class="minimap-player"></div>
                </div>
            </div>
        </div>

        <div id="questLog">
            <div class="quest-title">Miss√£o Atual</div>
            <div class="quest-description" id="questDescription">Fale com o Elder em Valedorn</div>
        </div>

        <div class="region-indicator" id="regionIndicator">
            <div class="region-name" id="regionName">Valedorn</div>
            <div class="region-subtitle">Reino dos Cavaleiros</div>
        </div>

        <div id="dialogueSystem">
            <div class="dialogue-box">
                <div class="dialogue-speaker">
                    <div class="speaker-portrait" id="speakerPortrait"></div>
                    <span id="speakerName">Nome</span>
                </div>
                <div class="dialogue-text" id="dialogueText"></div>
                <div class="dialogue-choices" id="dialogueChoices"></div>
                <div class="dialogue-indicator" id="dialogueIndicator">‚ñº</div>
            </div>
        </div>

        <div class="controls-container">
            <div class="joystick-area interactive">
                <div class="joystick" id="joystick">
                    <div class="joystick-knob" id="joystickKnob"></div>
                </div>
            </div>
            
            <div class="action-buttons">
                <div class="action-row">
                    <div class="action-btn echo interactive" onclick="useEcho()" id="btnEcho">üîÆ</div>
                    <div class="action-btn interact interactive" onclick="interact()" id="btnInteract">üëã</div>
                </div>
                <div class="action-row">
                    <div class="action-btn attack interactive" onclick="attack()" id="btnAttack">‚öîÔ∏è</div>
                </div>
            </div>
        </div>
    </div>

    <div class="damage-overlay" id="damageOverlay"></div>
    <div id="notificationArea"></div>

    <!-- Menu de Pausa -->
    <div id="pauseMenu" class="interactive">
        <div class="pause-title">JOGO PAUSADO</div>
        <div class="menu-options" style="max-width: 300px;">
            <button class="menu-btn" onclick="resumeGame()">Continuar</button>
            <button class="menu-btn" onclick="saveGame()">Salvar Jogo</button>
            <button class="menu-btn" onclick="returnToMenu()">Menu Principal</button>
        </div>
    </div>

    <script>
        // Sistema de Salvamento
        const SaveSystem = {
            save(gameData) {
                try {
                    const saveData = {
                        ...gameData,
                        timestamp: Date.now(),
                        version: '1.0'
                    };
                    localStorage.setItem('aetherion_save', JSON.stringify(saveData));
                    localStorage.setItem('aetherion_backup', JSON.stringify(saveData));
                    return true;
                } catch(e) {
                    console.error('Erro ao salvar:', e);
                    return false;
                }
            },

            load() {
                try {
                    const data = localStorage.getItem('aetherion_save') || localStorage.getItem('aetherion_backup');
                    return data ? JSON.parse(data) : null;
                } catch(e) {
                    console.error('Erro ao carregar:', e);
                    return null;
                }
            },

            hasSave() {
                return !!localStorage.getItem('aetherion_save');
            },

            autoSave(gameData) {
                if (gameData.playTime % 300 < 1) { // A cada 5 minutos
                    this.save(gameData);
                    showNotification('Jogo salvo automaticamente');
                }
            }
        };

        // Canvas e Contexto
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Estado Global do Jogo
        const Game = {
            state: 'menu', // menu, loading, playing, paused, dialogue
            lastTime: 0,
            deltaTime: 0,
            playTime: 0,
            currentRegion: 'valedorn',
            
            // Stats do jogador
            player: {
                x: 0,
                y: 0,
                vx: 0,
                vy: 0,
                speed: 4,
                direction: 1,
                level: 1,
                exp: 0,
                expToNext: 100,
                hp: 100,
                maxHp: 100,
                mana: 100,
                maxMana: 100,
                crystals: 0,
                gold: 0,
                inventory: [],
                skills: {
                    guardian: 0,
                    arcanist: 0,
                    wanderer: 0
                }
            },

            // Mundo
            camera: { x: 0, y: 0 },
            entities: [],
            particles: [],
            lights: [],
            trees: [],
            buildings: [],
            npcs: [],
            enemies: [],
            quests: [],
            currentQuest: null,
            dialogues: new Map(),
            
            // Input
            input: { x: 0, y: 0, active: false },
            
            // Flags de hist√≥ria
            story: {
                act: 1,
                awakened: false,
                metElder: false,
                firstCrystal: false,
                mordrathRevealed: false,
                choices: []
            }
        };

        // Dicas de carregamento
        const loadingTips = [
            "Os cristais antigos sussurram segredos do passado...",
            "Mordrath j√° foi um her√≥i antes de cair em desgra√ßa...",
            "Os Portadores do Eco s√£o raros, nascem uma vez a cada mil√™nio...",
            "A Floresta de Nythera esconde criaturas que n√£o devem ser despertadas...",
            "O Deserto de Khar'Zul foi outrora um o√°sis pr√≥spero...",
            "As Ilhas Suspensas de L√∫men desafiam as leis da natureza...",
            "Suas escolhas moldar√£o o destino de Aetherion..."
        ];

        // Regi√µes do mundo
        const WorldRegions = {
            valedorn: {
                name: 'Valedorn',
                subtitle: 'Reino dos Cavaleiros',
                size: { width: 4000, height: 3000 },
                groundColor1: '#3d5c48',
                groundColor2: '#2d4a38',
                skyColor: '#87ceeb',
                fogColor: 'rgba(135, 206, 235, 0.2)',
                treeColor: '#1a3d2e',
                lightColor: 'rgba(255, 220, 150, 0.3)',
                music: 'medieval',
                levelRange: [1, 10],
                enemies: ['wolf', 'bandit', 'corrupted_deer'],
                npcs: ['elder', 'merchant', 'guard', 'villager']
            },
            nythera: {
                name: 'Floresta de Nythera',
                subtitle: 'Dom√≠nio das Sombras Vivas',
                size: { width: 5000, height: 4000 },
                groundColor1: '#1e3d2f',
                groundColor2: '#0f291e',
                skyColor: '#2d4a3e',
                fogColor: 'rgba(45, 74, 62, 0.4)',
                treeColor: '#051a12',
                lightColor: 'rgba(100, 255, 150, 0.2)',
                music: 'mystical',
                levelRange: [10, 25],
                enemies: ['shadow_wolf', 'treant', 'dark_spirit', 'spider'],
                npcs: ['druid', 'hunter', 'hermit']
            },
            kharzul: {
                name: 'Deserto de Khar\'Zul',
                subtitle: 'Ru√≠nas do Imp√©rio Dourado',
                size: { width: 6000, height: 4500 },
                groundColor1: '#d4c4a0',
                groundColor2: '#b8a880',
                skyColor: '#ffcc80',
                fogColor: 'rgba(255, 200, 150, 0.3)',
                treeColor: '#8b7355',
                lightColor: 'rgba(255, 200, 100, 0.4)',
                music: 'desert',
                levelRange: [25, 40],
                enemies: ['sand_worm', 'mummy', 'desert_bandit', 'scorpion'],
                npcs: ['nomad', 'archaeologist', 'mystic']
            },
            lumen: {
                name: 'Ilhas Suspensas de L√∫men',
                subtitle: 'Legado dos Antigos',
                size: { width: 4000, height: 3500 },
                groundColor1: '#4a5568',
                groundColor2: '#2d3748',
                skyColor: '#1a202c',
                fogColor: 'rgba(100, 150, 255, 0.3)',
                treeColor: '#2d3748',
                lightColor: 'rgba(100, 200, 255, 0.5)',
                music: 'ethereal',
                levelRange: [40, 50],
                enemies: ['sky_serpent', 'automaton', 'void_mage'],
                npcs: ['scholar', 'guardian', 'traveler']
            }
        };

        // Sistema de Di√°logos Massivo
        const DialogueSystem = {
            current: null,
            textIndex: 0,
            charIndex: 0,
            isTyping: false,
            speed: 30,

            start(dialogueId) {
                const dialogue = Dialogues[dialogueId];
                if (!dialogue) return;
                
                this.current = dialogue;
                this.textIndex = 0;
                this.charIndex = 0;
                this.isTyping = true;
                Game.state = 'dialogue';
                
                document.getElementById('dialogueSystem').style.display = 'block';
                document.getElementById('speakerName').textContent = dialogue.speaker;
                document.getElementById('speakerPortrait').style.background = dialogue.portrait || 'linear-gradient(135deg, #2a2a3e, #1a1a2e)';
                
                this.typeText();
            },

            typeText() {
                if (!this.current || !this.isTyping) return;
                
                const text = this.current.texts[this.textIndex];
                if (this.charIndex < text.length) {
                    document.getElementById('dialogueText').textContent = text.substring(0, this.charIndex + 1);
                    this.charIndex++;
                    setTimeout(() => this.typeText(), this.speed);
                } else {
                    this.isTyping = false;
                    this.showChoices();
                }
            },

            showChoices() {
                const choicesDiv = document.getElementById('dialogueChoices');
                choicesDiv.innerHTML = '';
                
                const currentText = this.current.texts[this.textIndex];
                const choices = this.current.choices[currentText] || [];
                
                if (choices.length === 0) {
                    // Di√°logo termina
                    setTimeout(() => this.end(), 2000);
                    return;
                }

                choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = choice.text;
                    btn.onclick = () => this.selectChoice(choice);
                    choicesDiv.appendChild(btn);
                });
            },

            selectChoice(choice) {
                if (choice.action) choice.action();
                
                if (choice.next) {
                    this.start(choice.next);
                } else {
                    this.textIndex++;
                    this.charIndex = 0;
                    this.isTyping = true;
                    document.getElementById('dialogueChoices').innerHTML = '';
                    this.typeText();
                }
            },

            end() {
                this.current = null;
                document.getElementById('dialogueSystem').style.display = 'none';
                Game.state = 'playing';
            },

            skip() {
                if (this.isTyping) {
                    this.isTyping = false;
                    const text = this.current.texts[this.textIndex];
                    document.getElementById('dialogueText').textContent = text;
                    this.showChoices();
                } else {
                    this.textIndex++;
                    if (this.textIndex >= this.current.texts.length) {
                        this.end();
                    } else {
                        this.charIndex = 0;
                        this.isTyping = true;
                        document.getElementById('dialogueChoices').innerHTML = '';
                        this.typeText();
                    }
                }
            }
        };

        // Banco de Di√°logos Extensivo
        const Dialogues = {
            'intro_awakening': {
                speaker: '???',
                portrait: 'linear-gradient(135deg, #2a2a3e, #000)',
                texts: [
                    "Voc√™... pode me ouvir?",
                    "Sou eu... o Eco. A mem√≥ria do mundo.",
                    "Voc√™ caiu, jovem portador. O vilarejo foi destru√≠do.",
                    "Mas voc√™ sobreviveu. N√£o... voc√™ foi escolhido.",
                    "Toque no fragmento cristalino ao seu lado. Desperte seu verdadeiro poder."
                ],
                choices: {
                    "Toque no fragmento cristalino ao seu lado. Desperte seu verdadeiro poder.": [
                        { text: "Tocar o fragmento", action: () => {
                            Game.story.awakened = true;
                            Game.player.maxHp += 50;
                            Game.player.hp = Game.player.maxHp;
                            Game.player.maxMana += 30;
                            Game.player.mana = Game.player.maxMana;
                            showNotification('Poder do Eco Despertado!');
                            spawnParticles(Game.player.x, Game.player.y, 'awakening', 30);
                        }, next: 'intro_post_awakening' }
                    ]
                }
            },

            'intro_post_awakening': {
                speaker: 'Eco',
                portrait: 'linear-gradient(135deg, #4a90e2, #1e3a5f)',
                texts: [
                    "Sinto... sinto sua ess√™ncia mudar.",
                    "Voc√™ agora pode ouvir as mem√≥rias do mundo. Ver o que outros n√£o veem.",
                    "Valedorn est√° em ru√≠nas. Mordrath... ele veio primeiro.",
                    "Voc√™ deve encontrar o Elder. Ele sobreviveu, escondido nas catacumbas.",
                    "Mas cuidado... as criaturas corrompidas ainda vagam pelas ruas."
                ],
                choices: {
                    "Mas cuidado... as criaturas corrompidas ainda vagam pelas ruas.": [
                        { text: "Onde fica as catacumbas?", next: 'intro_catacombs' },
                        { text: "Quem √© Mordrath?", next: 'intro_mordrath' }
                    ]
                }
            },

            'intro_catacombs': {
                speaker: 'Eco',
                texts: [
                    "A leste do vilarejo, onde a antiga igreja se erguia.",
                    "Siga o caminho de pedras azuis. Eles ainda pulsam com magia residual.",
                    "As portas estar√£o seladas, mas voc√™... voc√™ pode abri-las agora.",
                    "Use seu poder. Concentre-se nas runas."
                ],
                choices: {
                    "Use seu poder. Concentre-se nas runas.": [
                        { text: "Entendido", action: () => {
                            startQuest('find_elder');
                        }}
                    ]
                }
            },

            'intro_mordrath': {
                speaker: 'Eco',
                texts: [
                    "Mordrath... o Guardi√£o Ca√≠do.",
                    "Ele foi o maior her√≥i de Aetherion. Salvou o mundo das Trevas Primordiais.",
                    "Mas o poder o corrompeu. Ele queria controlar o destino, n√£o apenas proteg√™-lo.",
                    "O Conselho o parou. Selaram-no nas profundezas.",
                    "Agora ele voltou. E quebra os cristais que mant√™m nosso mundo em equil√≠brio."
                ],
                choices: {
                    "Agora ele voltou. E quebra os cristais que mant√™m nosso mundo em equil√≠brio.": [
                        { text: "Como posso det√™-lo?", next: 'intro_stop_mordrath' }
                    ]
                }
            },

            'elder_first_meeting': {
                speaker: 'Elder Thorne',
                portrait: 'linear-gradient(135deg, #5c4033, #3d2817)',
                texts: [
                    "Pelos deuses... um Portador do Eco! Achei que sua linhagem havia acabado.",
                    "Voc√™ √© nossa √∫ltima esperan√ßa, jovem. A √∫nica chance de restaurar o equil√≠brio.",
                    "Mordrath busca os Quatro Fragmentos do Cristal Primordial.",
                    "Se ele reunir todos... poder√° reescrever a realidade segundo sua vontade distorcida.",
                    "Voc√™ deve encontr√°-los primeiro. Cada fragmento est√° em uma das grandes regi√µes."
                ],
                choices: {
                    "Voc√™ deve encontr√°-los primeiro. Cada fragmento est√° em uma das grandes regi√µes.": [
                        { text: "Onde come√ßo?", next: 'elder_quest_start' },
                        { text: "Por que eu? Sou apenas um campon√™s.", next: 'elder_destiny' }
                    ]
                }
            },

            'elder_quest_start': {
                speaker: 'Elder Thorne',
                texts: [
                    "A Floresta de Nythera √© seu primeiro destino.",
                    "L√°, a Druida Sylvana guarda o Fragmento da Vida.",
                    "Mas ela n√£o o entregar√° facilmente. Prove seu valor.",
                    "Complete as tr√™s provas da floresta.",
                    "E cuidado... Nythera mudou desde a Queda dos Cristais."
                ],
                choices: {
                    "E cuidado... Nythera mudou desde a Queda dos Cristais.": [
                        { text: "Partirei imediatamente", action: () => {
                            Game.story.metElder = true;
                            startQuest('first_fragment');
                            showNotification('Nova Miss√£o: O Fragmento da Vida');
                        }}
                    ]
                }
            },

            'sylvana_first': {
                speaker: 'Druida Sylvana',
                portrait: 'linear-gradient(135deg, #2d5a3d, #1a3d2e)',
                texts: [
                    "Um Portador... em minha floresta. Sinto o Eco em voc√™, crian√ßa.",
                    "Voc√™ busca o Fragmento. Todos os poderosos o fazem ultimamente.",
                    "Mas poder n√£o √© suficiente. A floresta exige harmonia.",
                    "Complete as Tr√™s Provas: Coragem, Sabedoria e Compaix√£o.",
                    "S√≥ ent√£o saberei se voc√™ √© digno de proteger o Fragmento."
                ],
                choices: {
                    "S√≥ ent√£o saberei se voc√™ √© digno de proteger o Fragmento.": [
                        { text: "Estou pronto para as provas", next: 'sylvana_trial_courage' }
                    ]
                }
            },

            'khalim_secret': {
                speaker: 'Khalim, o Andarilho',
                portrait: 'linear-gradient(135deg, #8b7355, #5c4033)',
                texts: [
                    "Shhh! Mantenha a voz baixa, amigo. Os esp√≠ritos do deserto t√™m ouvidos agu√ßados.",
                    "Voc√™ busca o Fragmento de Khar'Zul? Todos o fazem.",
                    "Mas sabe o segredo? O verdadeiro Fragmento n√£o est√° nas ru√≠nas principais.",
                    "Est√° escondido... no O√°sis Proibido. Onde a √°gua ainda flui magicamente.",
                    "Posso mostrar o caminho. Por um pre√ßo, √© claro."
                ],
                choices: {
                    "Posso mostrar o caminho. Por um pre√ßo, √© claro.": [
                        { text: "Quanto?", next: 'khalim_price' },
                        { text: "N√£o confio em voc√™", next: 'khalim_persuade' }
                    ]
                }
            },

            'mordrath_confrontation_1': {
                speaker: 'Mordrath, o Ca√≠do',
                portrait: 'linear-gradient(135deg, #1a1a2e, #000)',
                texts: [
                    "Ent√£o... o novo Portador finalmente aparece.",
                    "Voc√™ se parece comigo, sabia? T√£o jovem, t√£o cheio de certezas.",
                    "Pensa que est√° fazendo o bem. Protegendo o 'equil√≠brio'.",
                    "Mas j√° parou para pensar? O equil√≠brio significa estagna√ß√£o.",
                    "Sem mudan√ßa, n√£o h√° evolu√ß√£o. Sem evolu√ß√£o, n√£o h√° esperan√ßa.",
                    "Eu ofere√ßo transforma√ß√£o. Um mundo onde o sofrimento √© opcional.",
                    "Junte-se a mim. Juntos, podemos criar algo... perfeito."
                ],
                choices: {
                    "Junte-se a mim. Juntos, podemos criar algo... perfeito.": [
                        { text: "Nunca! Voc√™ destruiu meu lar!", next: 'mordrath_fight_1', action: () => Game.story.choices.push('rejected_mordrath') },
                        { text: "Transforma√ß√£o? Explique melhor...", next: 'mordrath_tempt', action: () => Game.story.choices.push('listened_mordrath') },
                        { text: "[Atacar imediatamente]", action: () => startBossFight('mordrath_1') }
                    ]
                }
            },

            'ending_sacrifice': {
                speaker: 'Eco Final',
                texts: [
                    "Voc√™ escolheu... o sacrif√≠cio.",
                    "Seu corpo se dissolver√°, mas sua ess√™ncia permanecer√° no Cristal.",
                    "Voc√™ se tornar√° o novo Guardi√£o. Eterno. Solit√°rio.",
                    "Mas Aetherion viver√°. Prosperar√°.",
                    "Sua hist√≥ria ser√° contada por mil√™nios. O Portador que se tornou Luz.",
                    "Est√° pronto para sua √∫ltima escolha?"
                ],
                choices: {
                    "Est√° pronto para sua √∫ltima escolha?": [
                        { text: "Sou o Eco. Sou Aetherion.", action: () => triggerEnding('sacrifice') }
                    ]
                }
            }
        };

        // Sistema de Miss√µes
        class Quest {
            constructor(id, title, description, objectives, rewards) {
                this.id = id;
                this.title = title;
                this.description = description;
                this.objectives = objectives;
                this.completed = false;
                this.currentObjective = 0;
                this.rewards = rewards;
            }

            update(objectiveIndex) {
                if (objectiveIndex === this.currentObjective) {
                    this.currentObjective++;
                    showNotification(`Objetivo completo: ${this.objectives[objectiveIndex]}`);
                    
                    if (this.currentObjective >= this.objectives.length) {
                        this.complete();
                    } else {
                        updateQuestLog();
                    }
                    return true;
                }
                return false;
            }

            complete() {
                this.completed = true;
                showNotification(`Miss√£o completa: ${this.title}`);
                
                // Dar recompensas
                if (this.rewards.exp) {
                    Game.player.exp += this.rewards.exp;
                    checkLevelUp();
                }
                if (this.rewards.gold) {
                    Game.player.gold += this.rewards.gold;
                    updateResources();
                }
                if (this.rewards.items) {
                    this.rewards.items.forEach(item => Game.player.inventory.push(item));
                }
                
                Game.currentQuest = null;
                document.getElementById('questLog').style.display = 'none';
            }
        }

        const QuestDatabase = {
            'awakening': new Quest('awakening', 'O Despertar', 'Descubra o poder dentro de voc√™', 
                ['Sobreviva ao ataque', 'Toque no fragmento cristalino', 'Fale com o Eco'], 
                { exp: 100, gold: 0 }),
            
            'find_elder': new Quest('find_elder', 'O √öltimo Conselheiro', 'Encontre o Elder nas catacumbas',
                ['V√° para as catacumbas a leste', 'Abra as portas seladas', 'Fale com o Elder'],
                { exp: 200, gold: 50 }),
            
            'first_fragment': new Quest('first_fragment', 'O Fragmento da Vida', 'Obtenha o primeiro fragmento em Nythera',
                ['Viaje para Nythera', 'Encontre a Druida Sylvana', 'Complete as Tr√™s Provas', 'Obtenha o Fragmento'],
                { exp: 1000, gold: 200, items: ['crystal_fragment_1'] }),
            
            'desert_fragment': new Quest('desert_fragment', 'Segredos de Areia', 'Encontre o Fragmento do Deserto',
                ['Viaje para Khar\'Zul', 'Descubra a localiza√ß√£o do O√°sis Proibido', 'Supere as armadilhas antigas', 'Recupere o Fragmento'],
                { exp: 2500, gold: 500, items: ['crystal_fragment_2'] }),
            
            'sky_fragment': new Quest('sky_fragment', 'Ascens√£o', 'Alcance as Ilhas Suspensas',
                ['Encontre o m√©todo de ascens√£o', 'Suba √†s Ilhas de L√∫men', 'Prove-se digno aos Guardi√µes Antigos', 'Obtenha o Fragmento Celestial'],
                { exp: 5000, gold: 1000, items: ['crystal_fragment_3'] }),
            
            'final_confrontation': new Quest('final_confrontation', 'O Destino de Aetherion', 'Enfrente Mordrath',
                ['Re√∫na todos os fragmentos', 'V√° para o Cristal Central', 'Derrote Mordrath', 'Tome sua decis√£o final'],
                { exp: 10000, gold: 5000 })
        };

        // Inicializa√ß√£o
        function init() {
            resize();
            window.addEventListener('resize', resize);
            
            // Verificar save existente
            if (SaveSystem.hasSave()) {
                const saveInfo = SaveSystem.load();
                const date = new Date(saveInfo.timestamp);
                document.getElementById('saveInfo').textContent = 
                    `N√≠vel ${saveInfo.player.level} - ${saveInfo.currentRegion} - ${date.toLocaleDateString()}`;
            }
            
            // Setup controles
            setupJoystick();
            setupTouchControls();
            
            // Loop do menu
            requestAnimationFrame(menuLoop);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function setupJoystick() {
            const joystick = document.getElementById('joystick');
            const knob = document.getElementById('joystickKnob');
            let active = false;
            let center = { x: 0, y: 0 };

            const handleStart = (e) => {
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                const rect = joystick.getBoundingClientRect();
                center = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
                active = true;
                updateJoystick(touch.clientX, touch.clientY);
            };

            const handleMove = (e) => {
                if (!active) return;
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                updateJoystick(touch.clientX, touch.clientY);
            };

            const handleEnd = () => {
                active = false;
                Game.input.x = 0;
                Game.input.y = 0;
                knob.style.transform = `translate(-50%, -50%)`;
            };

            const updateJoystick = (clientX, clientY) => {
                const maxDist = 35;
                let dx = clientX - center.x;
                let dy = clientY - center.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > maxDist) {
                    dx = (dx / dist) * maxDist;
                    dy = (dy / dist) * maxDist;
                }
                
                knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                
                Game.input.x = dx / maxDist;
                Game.input.y = dy / maxDist;
                Game.input.active = true;
            };

            joystick.addEventListener('touchstart', handleStart, {passive: false});
            joystick.addEventListener('touchmove', handleMove, {passive: false});
            joystick.addEventListener('touchend', handleEnd);
            joystick.addEventListener('touchcancel', handleEnd);
        }

        function setupTouchControls() {
            // Prevenir comportamentos padr√£o de touch
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.interactive')) return;
                e.preventDefault();
            }, { passive: false });

            // Double tap para pausa
            let lastTap = 0;
            document.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 500 && tapLength > 0 && Game.state === 'playing') {
                    togglePause();
                }
                lastTap = currentTime;
            });
        }

        // Loops do Jogo
        function menuLoop() {
            if (Game.state !== 'menu') return;
            
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Part√≠culas de fundo do menu
            const time = Date.now() * 0.001;
            for (let i = 0; i < 60; i++) {
                const x = ((time * 20 + i * 137) % (canvas.width + 100)) - 50;
                const y = ((i * 89) % canvas.height);
                const size = Math.sin(time + i) * 2 + 3;
                const alpha = 0.2 + Math.sin(time * 0.5 + i) * 0.2;
                
                ctx.fillStyle = `rgba(224, 213, 181, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            requestAnimationFrame(menuLoop);
        }

        function gameLoop(timestamp) {
            if (Game.state !== 'playing') {
                if (Game.state === 'playing') requestAnimationFrame(gameLoop);
                return;
            }

            Game.deltaTime = timestamp - Game.lastTime;
            Game.lastTime = timestamp;
            Game.playTime += Game.deltaTime / 1000;

            update();
            render();
            
            // Auto-save
            if (Math.floor(Game.playTime) % 300 === 0) {
                saveGameData();
            }

            requestAnimationFrame(gameLoop);
        }

        // Atualiza√ß√£o L√≥gica
        function update() {
            // Movimento do jogador
            if (Game.input.active) {
                Game.player.vx = Game.input.x * Game.player.speed;
                Game.player.vy = Game.input.y * Game.player.speed;
            } else {
                Game.player.vx *= 0.85;
                Game.player.vy *= 0.85;
            }

            // Aplicar movimento com colis√£o
            const newX = Game.player.x + Game.player.vx;
            const newY = Game.player.y + Game.player.vy;
            const region = WorldRegions[Game.currentRegion];
            
            if (newX > -region.size.width/2 && newX < region.size.width/2) {
                Game.player.x = newX;
            }
            if (newY > -region.size.height/2 && newY < region.size.height/2) {
                Game.player.y = newY;
            }

            // Dire√ß√£o
            if (Game.input.x !== 0) {
                Game.player.direction = Game.input.x > 0 ? 1 : -1;
            }

            // C√¢mera suave
            Game.camera.x += (Game.player.x - Game.camera.x) * 0.1;
            Game.camera.y += (Game.player.y - Game.camera.y) * 0.1;

            // Regenera√ß√£o
            if (Game.player.mana < Game.player.maxMana) {
                Game.player.mana += 0.05;
                updateStats();
            }
            if (Game.player.hp < Game.player.maxHp) {
                Game.player.hp += 0.02;
                updateStats();
            }

            // Atualizar entidades
            updateEntities();
            updateParticles();
            updateTrees();

            // Verificar mudan√ßa de regi√£o
            checkRegionTransition();
        }

        function updateEntities() {
            // Inimigos
            Game.enemies.forEach(enemy => {
                if (enemy.hp <= 0) return;
                
                const dx = Game.player.x - enemy.x;
                const dy = Game.player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < 400 && dist > 40) {
                    enemy.x += (dx / dist) * enemy.speed;
                    enemy.y += (dy / dist) * enemy.speed;
                } else if (dist <= 40 && !enemy.attackCooldown) {
                    // Atacar jogador
                    damagePlayer(enemy.damage);
                    enemy.attackCooldown = 60;
                }
                
                if (enemy.attackCooldown > 0) enemy.attackCooldown--;
            });

            // NPCs
            Game.npcs.forEach(npc => {
                // Comportamento idle
                npc.idleTimer = (npc.idleTimer || 0) + 1;
                if (npc.idleTimer > 200) {
                    npc.targetX = npc.x + (Math.random() - 0.5) * 100;
                    npc.targetY = npc.y + (Math.random() - 0.5) * 100;
                    npc.idleTimer = 0;
                }
                
                if (npc.targetX !== undefined) {
                    const dx = npc.targetX - npc.x;
                    const dy = npc.targetY - npc.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 5) {
                        npc.x += (dx / dist) * 0.5;
                        npc.y += (dy / dist) * 0.5;
                    }
                }
            });
        }

        function updateParticles() {
            Game.particles = Game.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= p.decay;
                p.vy += p.gravity || 0;
                
                if (p.type === 'crystal') {
                    p.vy -= 0.05; // Flutuar
                    p.vx += Math.sin(Date.now() * 0.001 + p.offset) * 0.02;
                }
                
                return p.life > 0;
            });
        }

        function updateTrees() {
            const time = Date.now() * 0.001;
            Game.trees.forEach(tree => {
                tree.sway = Math.sin(time + tree.swayOffset) * tree.swayAmount;
            });
        }

        // Renderiza√ß√£o
        function render() {
            const region = WorldRegions[Game.currentRegion];
            
            // C√©u
            const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            skyGrad.addColorStop(0, region.skyColor);
            skyGrad.addColorStop(1, region.groundColor1);
            ctx.fillStyle = skyGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-Game.camera.x + canvas.width/2, -Game.camera.y + canvas.height/2);

            // Ch√£o com textura procedural
            renderGround(region);

            // Elementos do mundo ordenados por Y (profundidade)
            const renderList = [
                ...Game.buildings.map(b => ({...b, type: 'building'})),
                ...Game.trees.map(t => ({...t, type: 'tree'})),
                ...Game.npcs.map(n => ({...n, type: 'npc'})),
                ...Game.enemies.map(e => ({...e, type: 'enemy'})),
                {x: Game.player.x, y: Game.player.y, type: 'player'}
            ].sort((a, b) => a.y - b.y);

            renderList.forEach(obj => {
                switch(obj.type) {
                    case 'tree': renderTree(obj); break;
                    case 'building': renderBuilding(obj); break;
                    case 'npc': renderNPC(obj); break;
                    case 'enemy': renderEnemy(obj); break;
                    case 'player': renderPlayer(); break;
                }
            });

            // Efeitos de luz
            renderLights(region);

            ctx.restore();

            // Overlay de escurid√£o/vignette
            renderOverlay();
        }

        function renderGround(region) {
            const tileSize = 100;
            const startX = Math.floor((Game.camera.x - canvas.width) / tileSize) * tileSize;
            const startY = Math.floor((Game.camera.y - canvas.height) / tileSize) * tileSize;
            
            for (let x = startX; x < startX + canvas.width * 2; x += tileSize) {
                for (let y = startY; y < startY + canvas.height * 2; y += tileSize) {
                    const noise = Math.sin(x * 0.01) * Math.cos(y * 0.01);
                    ctx.fillStyle = noise > 0 ? region.groundColor1 : region.groundColor2;
                    ctx.fillRect(x, y, tileSize, tileSize);
                    
                    // Detalhes
                    if ((x + y) % 7 === 0) {
                        ctx.fillStyle = 'rgba(0,0,0,0.1)';
                        ctx.fillRect(x + 10, y + 10, 5, 5);
                    }
                }
            }
        }

        function renderTree(tree) {
            const sway = tree.sway || 0;
            
            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(tree.x, tree.y + 35, 30, 10, 0, 0, Math.PI * 2);
            ctx.fill();

            // Tronco
            ctx.fillStyle = '#3d2817';
            ctx.fillRect(tree.x - 8, tree.y - 20, 16, 55);

            // Galhos com sway
            ctx.save();
            ctx.translate(tree.x, tree.y - 20);
            ctx.rotate(sway * 0.02);
            
            // Copa - m√∫ltiplas camadas
            const colors = ['#1a3d2e', '#0f291e', '#051a12'];
            const sizes = [45, 35, 25];
            
            colors.forEach((color, i) => {
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(-sizes[i], 10);
                ctx.lineTo(0, -sizes[i] * 1.5);
                ctx.lineTo(sizes[i], 10);
                ctx.fill();
            });
            
            // Brilho nas folhas
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.beginPath();
            ctx.moveTo(-20, 0);
            ctx.lineTo(0, -40);
            ctx.lineTo(10, -5);
            ctx.fill();
            
            ctx.restore();
        }

        function renderBuilding(building) {
            // Base
            ctx.fillStyle = '#4a4a5a';
            ctx.fillRect(building.x - 40, building.y - 30, 80, 60);
            
            // Telhado
            ctx.fillStyle = '#8b4513';
            ctx.beginPath();
            ctx.moveTo(building.x - 50, building.y - 30);
            ctx.lineTo(building.x, building.y - 70);
            ctx.lineTo(building.x + 50, building.y - 30);
            ctx.fill();
            
            // Porta
            ctx.fillStyle = '#2a1a0a';
            ctx.fillRect(building.x - 12, building.y + 10, 24, 20);
            
            // Janelas com luz
            if (building.lit) {
                ctx.fillStyle = 'rgba(255, 220, 150, 0.8)';
                ctx.shadowBlur = 20;
                ctx.shadowColor = 'rgba(255, 220, 150, 0.5)';
            } else {
                ctx.fillStyle = '#1a1a2e';
                ctx.shadowBlur = 0;
            }
            ctx.fillRect(building.x - 25, building.y - 10, 15, 15);
            ctx.fillRect(building.x + 10, building.y - 10, 15, 15);
            ctx.shadowBlur = 0;
        }

        function renderNPC(npc) {
            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(npc.x, npc.y + 20, 15, 5, 0, 0, Math.PI * 2);
            ctx.fill();

            // Corpo
            ctx.fillStyle = npc.color || '#4a5568';
            ctx.fillRect(npc.x - 10, npc.y - 25, 20, 45);

            // Cabe√ßa
            ctx.fillStyle = '#d4a574';
            ctx.beginPath();
            ctx.arc(npc.x, npc.y - 35, 12, 0, Math.PI * 2);
            ctx.fill();

            // Indicador de intera√ß√£o
            if (npc.interactable) {
                const bounce = Math.sin(Date.now() * 0.005) * 3;
                ctx.fillStyle = '#ffd700';
                ctx.font = '20px Arial';
                ctx.fillText('!', npc.x - 5, npc.y - 50 + bounce);
            }
        }

        function renderEnemy(enemy) {
            if (enemy.hp <= 0) return;
            
            // Sombra distorcida
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(enemy.x, enemy.y + 25, 20, 8, 0, 0, Math.PI * 2);
            ctx.fill();

            // Corpo sombrio pulsante
            const pulse = Math.sin(Date.now() * 0.005) * 0.1 + 0.9;
            ctx.fillStyle = `rgba(26, 26, 46, ${pulse})`;
            ctx.beginPath();
            ctx.moveTo(enemy.x, enemy.y - 35);
            ctx.lineTo(enemy.x - 18, enemy.y + 25);
            ctx.lineTo(enemy.x, enemy.y + 15);
            ctx.lineTo(enemy.x + 18, enemy.y + 25);
            ctx.closePath();
            ctx.fill();

            // Olhos brilhantes
            const eyePulse = Math.sin(Date.now() * 0.008) * 0.3 + 0.7;
            ctx.fillStyle = `rgba(255, 0, 0, ${eyePulse})`;
            ctx.shadowBlur = 15;
            ctx.shadowColor = 'red';
            ctx.beginPath();
            ctx.arc(enemy.x - 7, enemy.y - 15, 4, 0, Math.PI * 2);
            ctx.arc(enemy.x + 7, enemy.y - 15, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Barra de vida
            const hpPercent = enemy.hp / enemy.maxHp;
            ctx.fillStyle = 'red';
            ctx.fillRect(enemy.x - 20, enemy.y - 45, 40 * hpPercent, 4);
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 1;
            ctx.strokeRect(enemy.x - 20, enemy.y - 45, 40, 4);
        }

        function renderPlayer() {
            const p = Game.player;
            
            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.beginPath();
            ctx.ellipse(p.x, p.y + 30, 18, 6, 0, 0, Math.PI * 2);
            ctx.fill();

            // Anima√ß√£o de caminhada
            const walkCycle = Math.sin(Date.now() * 0.01) * 5;
            const bob = (Math.abs(p.vx) > 0.1 || Math.abs(p.vy) > 0.1) ? Math.sin(Date.now() * 0.015) * 3 : 0;

            // Capa (anima√ß√£o)
            ctx.fillStyle = '#8b4513';
            ctx.beginPath();
            ctx.moveTo(p.x - 12 * p.direction, p.y - 15 + bob);
            ctx.lineTo(p.x - 25 * p.direction, p.y + 25 + walkCycle);
            ctx.lineTo(p.x - 5 * p.direction, p.y + 20 + bob);
            ctx.fill();

            // Pernas
            ctx.fillStyle = '#2c3e50';
            if (Math.abs(p.vx) > 0.1 || Math.abs(p.vy) > 0.1) {
                ctx.fillRect(p.x - 8, p.y + 10 + bob, 6, 20 + walkCycle);
                ctx.fillRect(p.x + 2, p.y + 10 + bob, 6, 20 - walkCycle);
            } else {
                ctx.fillRect(p.x - 8, p.y + 10 + bob, 6, 20);
                ctx.fillRect(p.x + 2, p.y + 10 + bob, 6, 20);
            }

            // Corpo
            ctx.fillStyle = '#34495e';
            ctx.fillRect(p.x - 11, p.y - 20 + bob, 22, 35);

            // Cabe√ßa
            ctx.fillStyle = '#d4a574';
            ctx.beginPath();
            ctx.arc(p.x, p.y - 30 + bob, 11, 0, Math.PI * 2);
            ctx.fill();

            // Olhos do Eco (brilho azul)
            const eyeGlow = Math.sin(Date.now() * 0.003) * 0.3 + 0.7;
            ctx.fillStyle = `rgba(100, 200, 255, ${eyeGlow})`;
            ctx.shadowBlur = 10;
            ctx.shadowColor = 'rgba(100, 200, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(p.x - 4, p.y - 32 + bob, 2.5, 0, Math.PI * 2);
            ctx.arc(p.x + 4, p.y - 32 + bob, 2.5, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Arma
            ctx.fillStyle = '#silver';
            ctx.fillRect(p.x + 12 * p.direction, p.y - 5 + bob, 22, 4);
        }

        function renderLights(region) {
            // Luz ambiente da regi√£o
            Game.lights.forEach(light => {
                const gradient = ctx.createRadialGradient(
                    light.x, light.y, 0,
                    light.x, light.y, light.radius
                );
                gradient.addColorStop(0, light.color);
                gradient.addColorStop(1, 'transparent');
                
                ctx.globalCompositeOperation = 'screen';
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(light.x, light.y, light.radius, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalCompositeOperation = 'source-over';

            // Part√≠culas
            Game.particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.shadowBlur = p.glow || 0;
                ctx.shadowColor = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
        }

        function renderOverlay() {
            // Vignette
            const grad = ctx.createRadialGradient(
                canvas.width/2, canvas.height/2, 100,
                canvas.width/2, canvas.height/2, 800
            );
            grad.addColorStop(0, 'transparent');
            grad.addColorStop(1, 'rgba(0,0,0,0.6)');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // Gera√ß√£o Procedural do Mundo
        function generateWorld(regionName) {
            const region = WorldRegions[regionName];
            Game.entities = [];
            Game.trees = [];
            Game.buildings = [];
            Game.npcs = [];
            Game.enemies = [];
            Game.lights = [];

            // Gerar √°rvores
            for (let i = 0; i < 150; i++) {
                Game.trees.push({
                    x: (Math.random() - 0.5) * region.size.width * 0.8,
                    y: (Math.random() - 0.5) * region.size.height * 0.8,
                    swayOffset: Math.random() * Math.PI * 2,
                    swayAmount: 0.5 + Math.random() * 1.5,
                    type: Math.random() > 0.7 ? 'ancient' : 'normal'
                });
            }

            // Gerar edif√≠cios
            for (let i = 0; i < 20; i++) {
                Game.buildings.push({
                    x: (Math.random() - 0.5) * region.size.width * 0.6,
                    y: (Math.random() - 0.5) * region.size.height * 0.6,
                    lit: Math.random() > 0.3,
                    type: 'house'
                });
            }

            // Gerar NPCs
            region.npcs.forEach((type, i) => {
                Game.npcs.push({
                    x: (Math.random() - 0.5) * region.size.width * 0.5,
                    y: (Math.random() - 0.5) * region.size.height * 0.5,
                    type: type,
                    color: `hsl(${Math.random() * 360}, 40%, 40%)`,
                    interactable: true,
                    dialogue: type + '_first'
                });
            });

            // Gerar inimigos
            for (let i = 0; i < 15; i++) {
                const type = region.enemies[Math.floor(Math.random() * region.enemies.length)];
                Game.enemies.push({
                    x: (Math.random() - 0.5) * region.size.width * 0.9,
                    y: (Math.random() - 0.5) * region.size.height * 0.9,
                    type: type,
                    hp: 100,
                    maxHp: 100,
                    speed: 1 + Math.random(),
                    damage: 10 + Math.floor(Math.random() * 10),
                    attackCooldown: 0
                });
            }

            // Luzes ambiente
            for (let i = 0; i < 8; i++) {
                Game.lights.push({
                    x: (Math.random() - 0.5) * region.size.width,
                    y: (Math.random() - 0.5) * region.size.height,
                    radius: 150 + Math.random() * 100,
                    color: `rgba(255, 220, 150, 0.3)`
                });
            }

            // Cristais especiais
            if (regionName === 'valedorn' && !Game.story.firstCrystal) {
                Game.entities.push({
                    x: 200,
                    y: -100,
                    type: 'crystal_fragment',
                    interactable: true
                });
            }
        }

        // A√ß√µes do Jogador
        function attack() {
            // Criar hitbox de ataque
            const attackRange = 60;
            const attackX = Game.player.x + Game.player.direction * 40;
            const attackY = Game.player.y;

            // Part√≠culas
            for (let i = 0; i < 8; i++) {
                Game.particles.push({
                    x: attackX,
                    y: attackY,
                    vx: (Math.random() - 0.5) * 5,
                    vy: (Math.random() - 0.5) * 5,
                    life: 1,
                    decay: 0.05,
                    color: '#ffd700',
                    size: 3,
                    glow: 10
                });
            }

            // Verificar acertos
            let hit = false;
            Game.enemies.forEach(enemy => {
                const dx = enemy.x - attackX;
                const dy = enemy.y - attackY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < attackRange && enemy.hp > 0) {
                    enemy.hp -= 25;
                    hit = true;
                    
                    // Sangue/part√≠culas
                    for (let i = 0; i < 5; i++) {
                        Game.particles.push({
                            x: enemy.x,
                            y: enemy.y,
                            vx: (Math.random() - 0.5) * 3,
                            vy: (Math.random() - 0.5) * 3,
                            life: 0.8,
                            decay: 0.03,
                            color: '#8b0000',
                            size: 4
                        });
                    }

                    if (enemy.hp <= 0) {
                        showNotification('Inimigo derrotado!');
                        Game.player.exp += 50;
                        checkLevelUp();
                    }
                }
            });

            if (hit) {
                // Screen shake leve
                Game.camera.x += (Math.random() - 0.5) * 10;
                Game.camera.y += (Math.random() - 0.5) * 10;
            }
        }

        function useEcho() {
            if (Game.player.mana < 20) {
                showNotification('Mana insuficiente!');
                return;
            }

            Game.player.mana -= 20;
            updateStats();

            // Efeito visual massivo
            for (let i = 0; i < 30; i++) {
                const angle = (Math.PI * 2 / 30) * i;
                Game.particles.push({
                    x: Game.player.x,
                    y: Game.player.y,
                    vx: Math.cos(angle) * 3,
                    vy: Math.sin(angle) * 3,
                    life: 2,
                    decay: 0.02,
                    color: `hsl(${180 + Math.random() * 60}, 100%, 70%)`,
                    size: 5,
                    glow: 15,
                    type: 'crystal',
                    offset: i,
                    gravity: -0.02
                });
            }

            // Revelar segredos pr√≥ximos
            Game.entities.forEach(e => {
                if (e.type === 'secret' || e.type === 'crystal_fragment') {
                    const dx = e.x - Game.player.x;
                    const dy = e.y - Game.player.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 300) {
                        e.revealed = true;
                        showNotification('Eco revelou algo escondido!');
                    }
                }
            });

            showNotification('Eco usado!');
        }

        function interact() {
            // Verificar NPCs pr√≥ximos
            Game.npcs.forEach(npc => {
                const dx = npc.x - Game.player.x;
                const dy = npc.y - Game.player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < 60 && npc.dialogue) {
                    DialogueSystem.start(npc.dialogue);
                }
            });

            // Verificar objetos
            Game.entities.forEach(e => {
                if (!e.interactable) return;
                const dx = e.x - Game.player.x;
                const dy = e.y - Game.player.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < 50) {
                    if (e.type === 'crystal_fragment') {
                        collectCrystal();
                    }
                }
            });
        }

        // Sistema de Combate e Progress√£o
        function damagePlayer(amount) {
            Game.player.hp -= amount;
            updateStats();
            
            // Efeito visual
            document.getElementById('damageOverlay').classList.add('active');
            setTimeout(() => {
                document.getElementById('damageOverlay').classList.remove('active');
            }, 300);

            if (Game.player.hp <= 0) {
                playerDeath();
            }
        }

        function playerDeath() {
            showNotification('Voc√™ foi derrotado!');
            Game.player.hp = Game.player.maxHp;
            Game.player.x = 0;
            Game.player.y = 0;
            Game.camera.x = 0;
            Game.camera.y = 0;
        }

        function checkLevelUp() {
            while (Game.player.exp >= Game.player.expToNext) {
                Game.player.exp -= Game.player.expToNext;
                Game.player.level++;
                Game.player.expToNext = Math.floor(Game.player.expToNext * 1.5);
                Game.player.maxHp += 20;
                Game.player.maxMana += 10;
                Game.player.hp = Game.player.maxHp;
                Game.player.mana = Game.player.maxMana;
                
                showNotification(`N√≠vel ${Game.player.level}!`);
                updateStats();
            }
            document.getElementById('expFill').style.width = (Game.player.exp / Game.player.expToNext * 100) + '%';
        }

        function collectCrystal() {
            Game.player.crystals++;
            Game.story.firstCrystal = true;
            updateResources();
            showNotification('Fragmento de Cristal coletado!');
            
            // Efeito visual
            spawnParticles(Game.player.x, Game.player.y, 'crystal', 20);
        }

        function spawnParticles(x, y, type, count) {
            for (let i = 0; i < count; i++) {
                Game.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    life: 1.5,
                    decay: 0.02,
                    color: type === 'crystal' ? '#00ffff' : '#ffd700',
                    size: 3 + Math.random() * 3,
                    glow: 10
                });
            }
        }

        // Transi√ß√£o de Regi√µes
        function checkRegionTransition() {
            const p = Game.player;
            const region = WorldRegions[Game.currentRegion];
            
            // Verificar limites
            if (Math.abs(p.x) > region.size.width/2 || Math.abs(p.y) > region.size.height/2) {
                // Determinar pr√≥xima regi√£o baseado na dire√ß√£o
                let nextRegion = null;
                
                if (p.y < -region.size.height/2 && Game.currentRegion === 'valedorn') {
                    nextRegion = 'nythera';
                } else if (p.x > region.size.width/2 && Game.currentRegion === 'nythera') {
                    nextRegion = 'kharzul';
                } else if (p.y > region.size.height/2 && Game.currentRegion === 'kharzul') {
                    nextRegion = 'lumen';
                }

                if (nextRegion) {
                    transitionToRegion(nextRegion);
                } else {
                    // Bloquear sa√≠da
                    p.x = Math.max(-region.size.width/2 + 50, Math.min(region.size.width/2 - 50, p.x));
                    p.y = Math.max(-region.size.height/2 + 50, Math.min(region.size.height/2 - 50, p.y));
                    showNotification('Voc√™ n√£o pode ir ainda mais longe...');
                }
            }
        }

        function transitionToRegion(regionName) {
            Game.state = 'loading';
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.classList.add('active');
            
            // Dica aleat√≥ria
            document.getElementById('loadingTip').textContent = 
                loadingTips[Math.floor(Math.random() * loadingTips.length)];

            // Anima√ß√£o de progresso
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                document.getElementById('progressFill').style.width = progress + '%';
                
                if (progress === 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        Game.currentRegion = regionName;
                        Game.player.x = 0;
                        Game.player.y = 0;
                        generateWorld(regionName);
                        
                        loadingScreen.classList.remove('active');
                        document.getElementById('progressFill').style.width = '0%';
                        
                        // Mostrar indicador de regi√£o
                        const indicator = document.getElementById('regionIndicator');
                        document.getElementById('regionName').textContent = WorldRegions[regionName].name;
                        indicator.classList.add('show');
                        setTimeout(() => indicator.classList.remove('show'), 4000);
                        
                        Game.state = 'playing';
                        Game.lastTime = performance.now();
                        requestAnimationFrame(gameLoop);
                    }, 500);
                }
            }, 200);
        }

        // UI Updates
        function updateStats() {
            document.getElementById('healthFill').style.width = (Game.player.hp / Game.player.maxHp * 100) + '%';
            document.getElementById('manaFill').style.width = (Game.player.mana / Game.player.maxMana * 100) + '%';
            document.getElementById('levelBadge').textContent = Game.player.level;
        }

        function updateResources() {
            document.getElementById('crystalCount').textContent = `${Game.player.crystals}/4`;
            document.getElementById('goldCount').textContent = Game.player.gold;
        }

        function updateQuestLog() {
            if (Game.currentQuest) {
                document.getElementById('questDescription').textContent = 
                    Game.currentQuest.objectives[Game.currentQuest.currentObjective] || 'Miss√£o completa!';
            }
        }

        function showNotification(text) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.textContent = text;
            document.getElementById('notificationArea').appendChild(notif);
            setTimeout(() => notif.remove(), 4500);
        }

        function startQuest(questId) {
            const quest = QuestDatabase[questId];
            if (quest) {
                Game.currentQuest = quest;
                document.getElementById('questLog').style.display = 'block';
                updateQuestLog();
            }
        }

        // Controles de Menu
        function startNewGame() {
            // Resetar jogo
            Game.player = {
                x: 0, y: 0, vx: 0, vy: 0, speed: 4, direction: 1,
                level: 1, exp: 0, expToNext: 100,
                hp: 100, maxHp: 100, mana: 100, maxMana: 100,
                crystals: 0, gold: 0, inventory: [],
                skills: { guardian: 0, arcanist: 0, wanderer: 0 }
            };
            Game.story = { act: 1, awakened: false, metElder: false, firstCrystal: false, mordrathRevealed: false, choices: [] };
            Game.playTime = 0;
            Game.currentRegion = 'valedorn';
            
            startGame();
        }

        function loadGame() {
            const save = SaveSystem.load();
            if (save) {
                Object.assign(Game.player, save.player);
                Object.assign(Game.story, save.story);
                Game.currentRegion = save.currentRegion;
                Game.playTime = save.playTime || 0;
                startGame();
            } else {
                showNotification('Nenhum save encontrado!');
            }
        }

        function startGame() {
            document.getElementById('mainMenu').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('mainMenu').style.display = 'none';
                document.getElementById('gameHUD').style.display = 'block';
                
                generateWorld(Game.currentRegion);
                updateStats();
                updateResources();
                
                Game.state = 'playing';
                Game.lastTime = performance.now();
                requestAnimationFrame(gameLoop);
                
                // Iniciar primeira miss√£o se novo jogo
                if (!Game.story.awakened) {
                    setTimeout(() => {
                        DialogueSystem.start('intro_awakening');
                    }, 1000);
                }
            }, 1000);
        }

        function saveGameData() {
            const data = {
                player: Game.player,
                story: Game.story,
                currentRegion: Game.currentRegion,
                playTime: Game.playTime
            };
            SaveSystem.save(data);
        }

        function togglePause() {
            if (Game.state === 'playing') {
                Game.state = 'paused';
                document.getElementById('pauseMenu').style.display = 'flex';
            } else if (Game.state === 'paused') {
                resumeGame();
            }
        }

        function resumeGame() {
            document.getElementById('pauseMenu').style.display = 'none';
            Game.state = 'playing';
            Game.lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function saveGame() {
            saveGameData();
            showNotification('Jogo salvo com sucesso!');
        }

        function returnToMenu() {
            saveGameData();
            location.reload();
        }

        function showSettings() {
            alert('Configura√ß√µes:\n- Som: Ligado\n- Gr√°ficos: Alto\n- Auto-save: A cada 5 minutos\n- Idioma: Portugu√™s (Brasil)');
        }

        // Inicializar
        window.onload = init;
    </script>
</body>
</html>
